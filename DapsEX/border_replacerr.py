import logging
from collections.abc import Callable
from pathlib import Path

from PIL import Image

from DapsEX.database_cache import Database
from DapsEX.logger import init_logger
from DapsEX.settings import Settings
from DapsEX.utils import hash_file
from progress import ProgressState


class BorderReplacerr:
    def __init__(self, custom_color=None, payload=None) -> None:
        if payload:
            self.logger = logging.getLogger("BorderReplacerr")
            try:
                log_dir = Path(Settings.LOG_DIR.value) / Settings.BORDER_REPLACERR.value
                init_logger(
                    self.logger,
                    log_dir,
                    "border_replacerr",
                    log_level=payload.log_level if payload.log_level else logging.INFO,
                )
                self.db = Database(self.logger)
                self.target_path = Path(payload.target_path)
                self.backup_path = Path(Settings.ORIGINAL_POSTERS.value)
                self.border_setting = payload.border_setting
                self.custom_color = payload.custom_color
                self.asset_folders = payload.asset_folders

            except Exception as e:
                self.logger.exception("Failed to initialize BorderReplacerr")
                raise e
        else:
            self.custom_color = custom_color

    def _log_banner(self):
        self.logger.info("\n" + "#" * 80)
        self.logger.info("### New BorderReplacerr Run")
        self.logger.info("\n" + "#" * 80)

    def remove_border(self, image_path: Path):
        image = Image.open(image_path)
        width, height = image.size
        crop_area = (25, 25, width - 25, height)

        final_image = image.crop(crop_area)
        bottom_border = Image.new("RGB", (width - 2 * 25, 25), color="black")
        bottom_border_position = (0, final_image.size[1] - 25)
        final_image.paste(bottom_border, bottom_border_position)
        final_image = final_image.resize((1000, 1500)).convert("RGB")

        return final_image

    def replace_border(self, image_path: Path):
        image = Image.open(image_path)
        width, height = image.size
        crop_area = (25, 25, width - 25, height - 25)
        cropped_image = image.crop(crop_area)
        new_image = Image.new("RGB", (width, height), color=self.custom_color)
        new_image.paste(cropped_image, (25, 25))
        final_image = new_image.resize((1000, 1500)).convert("RGB")
        return final_image

    def replace_current_assets(
        self,
        cb: Callable[[str, int, ProgressState], None] | None = None,
        job_id: str | None = None,
    ):
        try:
            self._log_banner()
            original_poster_paths = [
                poster for poster in self.backup_path.rglob("*") if poster.is_file()
            ]
            if job_id and cb:
                cb(job_id, 20, ProgressState.IN_PROGRESS)
            for poster in original_poster_paths:
                try:
                    relative_path = poster.relative_to(self.backup_path)
                    target_path = self.target_path / relative_path

                    target_path.parent.mkdir(parents=True, exist_ok=True)

                    if self.border_setting == "remove":
                        new_image = self.remove_border(poster)
                        self.logger.info(f"Removed border for: {poster}")
                    elif self.border_setting in ["custom", "black"]:
                        new_image = self.replace_border(poster)
                        self.logger.info(f"Replaced border for: {poster}")
                    else:
                        self.logger.warning(
                            f"Unsupported border setting '{self.border_setting}' for: {poster}"
                        )
                        continue

                    new_image.save(target_path)
                    self.logger.info(f"Updated asset saved: {target_path}")

                    file_hash = hash_file(target_path, self.logger)
                    self.db.update_border_replaced_hash(
                        str(target_path),
                        file_hash,
                        True,
                        self.border_setting,
                        self.custom_color,
                    )
                except Exception as e:
                    self.logger.error(f"Error processing file '{poster}': {e}")
            self.logger.info("All assets have been updated successfully")
            if job_id and cb:
                cb(job_id, 100, ProgressState.COMPLETED)
        except Exception as e:
            self.logger.error(f"Critical error during asset replacement: {e}")
